<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="桃花影落飞神剑,碧海潮生按玉箫" href="http://yoursite.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="桃花影落飞神剑,碧海潮生按玉箫" href="http://yoursite.com/atom.xml"><link rel="alternate" type="application/json" title="桃花影落飞神剑,碧海潮生按玉箫" href="http://yoursite.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="kubernetes"><link rel="canonical" href="http://yoursite.com/kubernetes/Kubernetes8/"><title>08 数据存储 - kubernetes | 白墨小客栈 = 桃花影落飞神剑,碧海潮生按玉箫</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">08 数据存储</h1><div class="meta"><span class="item" title="创建时间：2022-10-22 20:59:07"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2022-10-22T20:59:07+08:00">2022-10-22</time></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">白墨小客栈</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclfdu6exj20zk0m87hw.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclgi503lj20zk0m8hdt.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giciundwu5j20zk0m8n9e.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicitf0kl1j20zk0m87fe.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclgrvbd6j20zk0m8qv5.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giciusoyjnj219g0u0x56.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/kubernetes/" itemprop="item" rel="index" title="分类于 kubernetes"><span itemprop="name">kubernetes</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://yoursite.com/kubernetes/Kubernetes8/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="baim0"><meta itemprop="description" content=", 描述123"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="桃花影落飞神剑,碧海潮生按玉箫"></span><div class="body md" itemprop="articleBody"><h1 id="第八章-数据存储"><a class="anchor" href="#第八章-数据存储">#</a> 第八章 数据存储</h1><p>​ 在前面已经提到，容器的生命周期可能很短，会被频繁地创建和销毁。那么容器在销毁时，保存在容器中的数据也会被清除。这种结果对用户来说，在某些情况下是不乐意看到的。为了持久化保存容器的数据，kubernetes 引入了 Volume 的概念。</p><p>​ Volume 是 Pod 中能够被多个容器访问的共享目录，它被定义在 Pod 上，然后被一个 Pod 里的多个容器挂载到具体的文件目录下，kubernetes 通过 Volume 实现同一个 Pod 中不同容器之间的数据共享以及数据的持久化存储。Volume 的生命容器不与 Pod 中单个容器的生命周期相关，当容器终止或者重启时，Volume 中的数据也不会丢失。</p><p>kubernetes 的 Volume 支持多种类型，比较常见的有下面几个：</p><ul><li>简单存储：EmptyDir、HostPath、NFS</li><li>高级存储：PV、PVC</li><li>配置存储：ConfigMap、Secret</li></ul><h2 id="基本存储"><a class="anchor" href="#基本存储">#</a> 基本存储</h2><h3 id="emptydir"><a class="anchor" href="#emptydir">#</a> EmptyDir</h3><p>​ EmptyDir 是最基础的 Volume 类型，一个 EmptyDir 就是 Host 上的一个空目录。</p><p>​ EmptyDir 是在 Pod 被分配到 Node 时创建的，它的初始内容为空，并且无须指定宿主机上对应的目录文件，因为 kubernetes 会自动分配一个目录，当 Pod 销毁时， EmptyDir 中的数据也会被永久删除。 EmptyDir 用途如下：</p><ul><li><p>临时空间，例如用于某些应用程序运行时所需的临时目录，且无须永久保留</p></li><li><p>一个容器需要从另一个容器中获取数据的目录（多容器共享目录）</p></li></ul><p>接下来，通过一个容器之间文件共享的案例来使用一下 EmptyDir。</p><p>​ 在一个 Pod 中准备两个容器 nginx 和 busybox，然后声明一个 Volume 分别挂在到两个容器的目录中，然后 nginx 容器负责向 Volume 中写日志，busybox 中通过命令将日志内容读到控制台。</p><p><img data-src="http://qiniu.baim0.cn/img/image-20200413174713773-20221022205941801-20221022211727763.png" alt=""></p><p>创建一个 volume-emptydir.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>emptydir</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.14<span class="token punctuation">-</span>alpine</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>  <span class="token comment"># 将 logs-volume 挂在到 nginx 容器中，对应的目录为 /var/log/nginx</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx</pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"tail -f /logs/access.log"</span><span class="token punctuation">]</span> <span class="token comment"># 初始命令，动态读取指定文件中内容</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>  <span class="token comment"># 将 logs-volume 挂在到 busybox 容器中，对应的目录为 /logs</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume</pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /logs</pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span> <span class="token comment"># 声明 volume， name 为 logs-volume，类型为 emptyDir</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 Pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl create -f volume-emptydir.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/volume-emptydir created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 pod</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl get pods volume-emptydir -n dev -o wide</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                  READY   STATUS    RESTARTS   AGE   IP             NODE   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>volume-emptydir   2/2     Running   0          97s   10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>1<span class="token punctuation">.</span>100   node1  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 通过 podIp 访问 nginx</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># curl 10.244.1.100</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 通过 kubectl logs 命令查看指定容器的标准输出</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl logs -f volume-emptydir -n dev -c busybox</span></pre></td></tr><tr><td data-num="16"></td><td><pre>10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0 <span class="token operator">-</span> <span class="token operator">-</span> <span class="token punctuation">[</span>13/Apr/2020:10:58:47 <span class="token operator">+</span>0000<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> 200 612 <span class="token string">"-"</span> <span class="token string">"curl/7.29.0"</span> <span class="token string">"-"</span></pre></td></tr></table></figure><h3 id="hostpath"><a class="anchor" href="#hostpath">#</a> HostPath</h3><p>​ 上节课提到，EmptyDir 中数据不会被持久化，它会随着 Pod 的结束而销毁，如果想简单的将数据持久化到主机中，可以选择 HostPath。</p><p>​ HostPath 就是将 Node 主机中一个实际目录挂在到 Pod 中，以供容器使用，这样的设计就可以保证 Pod 销毁了，但是数据依据可以存在于 Node 主机上。</p><p><img data-src="http://qiniu.baim0.cn/img/image-20200413214031331-20221022211743306.png" alt=""></p><p>创建一个 volume-hostpath.yaml：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>hostpath</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx</pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"tail -f /logs/access.log"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume</pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /logs</pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/logs</pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate  <span class="token comment"># 目录存在就使用，不存在就先创建后使用</span></pre></td></tr></table></figure><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre>关于type的值的一点说明：</pre></td></tr><tr><td data-num="2"></td><td><pre>	DirectoryOrCreate 目录存在就使用，不存在就先创建后使用</pre></td></tr><tr><td data-num="3"></td><td><pre>	Directory	目录必须存在</pre></td></tr><tr><td data-num="4"></td><td><pre>	FileOrCreate  文件存在就使用，不存在就先创建后使用</pre></td></tr><tr><td data-num="5"></td><td><pre>	File 文件必须存在	</pre></td></tr><tr><td data-num="6"></td><td><pre>    Socket	unix套接字必须存在</pre></td></tr><tr><td data-num="7"></td><td><pre>	CharDevice	字符设备必须存在</pre></td></tr><tr><td data-num="8"></td><td><pre>	BlockDevice 块设备必须存在</pre></td></tr></table></figure><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 Pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl create -f volume-hostpath.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/volume-hostpath created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 Pod</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl get pods volume-hostpath -n dev -o wide</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                  READY   STATUS    RESTARTS   AGE   IP             NODE   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="8"></td><td><pre>pod-volume-hostpath   2/2     Running   0          16s   10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>1<span class="token punctuation">.</span>104   node1  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#访问 nginx</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># curl 10.244.1.104</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 接下来就可以去 host 的 /root/logs 目录下查看存储的文件了</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">###  注意：下面的操作需要到 Pod 所在的节点运行（案例中是 node1）</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token namespace">[root@node1 ~]</span><span class="token comment"># ls /root/logs/</span></pre></td></tr><tr><td data-num="16"></td><td><pre>access<span class="token punctuation">.</span>log  error<span class="token punctuation">.</span>log</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment"># 同样的道理，如果在此目录下创建一个文件，到容器中也是可以看到的</span></pre></td></tr></table></figure><h3 id="nfs"><a class="anchor" href="#nfs">#</a> NFS</h3><p>​ HostPath 可以解决数据持久化的问题，但是一旦 Node 节点故障了，Pod 如果转移到了别的节点，又会出现问题了，此时需要准备单独的网络存储系统，比较常用的用 NFS、CIFS。</p><p>​ NFS 是一个网络文件存储系统，可以搭建一台 NFS 服务器，然后将 Pod 中的存储直接连接到 NFS 系统上，这样的话，无论 Pod 在节点上怎么转移，只要 Node 跟 NFS 的对接没问题，数据就可以成功访问。</p><p><img data-src="http://qiniu.baim0.cn/img/image-20200413215133559-20221022211800092.png" alt=""></p><p>1）首先要准备 nfs 的服务器，这里为了简单，直接是 master 节点做 nfs 服务器</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 在 master 上安装 nfs 服务</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># yum install nfs-utils -y</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 准备一个共享目录</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># mkdir /root/data/nfs -pv</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 将共享目录以读写权限暴露给 192.168.109.0/24 网段中的所有主机</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># vim /etc/exports</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># more /etc/exports</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token operator">/</span>root/<span class="token keyword">data</span><span class="token operator">/</span>nfs     192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>109<span class="token punctuation">.</span>0/24<span class="token punctuation">(</span>rw<span class="token punctuation">,</span>no_root_squash<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 启动 nfs 服务</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># systemctl start nfs</span></pre></td></tr></table></figure><p>2）接下来，要在的每个 node 节点上都安装下 nfs，这样的目的是为了 node 节点可以驱动 nfs 设备</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 在 node 上安装 nfs 服务，注意不需要启动</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># yum install nfs-utils -y</span></pre></td></tr></table></figure><p>3）接下来，就可以编写 pod 的配置文件了，创建 volume-nfs.yaml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>nfs</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx</pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"tail -f /logs/access.log"</span><span class="token punctuation">]</span> </pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume</pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /logs</pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">nfs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.109.100  <span class="token comment">#nfs 服务器地址</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/nfs <span class="token comment">#共享文件路径</span></pre></td></tr></table></figure><p>4）最后，运行下 pod，观察结果</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl create -f volume-nfs.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/volume-nfs created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 pod</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl get pods volume-nfs -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                  READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>volume-nfs        2/2     Running   0          2m9s</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 查看 nfs 服务器上的共享目录，发现已经有文件了</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># ls /root/data/</span></pre></td></tr><tr><td data-num="12"></td><td><pre>access<span class="token punctuation">.</span>log  error<span class="token punctuation">.</span>log</pre></td></tr></table></figure><p>## 高级存储</p><h3 id="pv和pvc"><a class="anchor" href="#pv和pvc">#</a> PV 和 PVC</h3><p>​ 前面已经学习了使用 NFS 提供存储，此时就要求用户会搭建 NFS 系统，并且会在 yaml 配置 nfs。由于 kubernetes 支持的存储系统有很多，要求客户全都掌握，显然不现实。为了能够屏蔽底层存储实现的细节，方便用户使用， kubernetes 引入 PV 和 PVC 两种资源对象。</p><p>​ PV（Persistent Volume）是持久化卷的意思，是对底层的共享存储的一种抽象。一般情况下 PV 由 kubernetes 管理员进行创建和配置，它与底层具体的共享存储技术有关，并通过插件完成与共享存储的对接。</p><p>​ PVC（Persistent Volume Claim）是持久卷声明的意思，是用户对于存储需求的一种声明。换句话说，PVC 其实就是用户向 kubernetes 系统发出的一种资源需求申请。</p><p><img data-src="http://qiniu.baim0.cn/img/image-20200514194111567-20221022211816339.png" alt=""></p><p>使用了 PV 和 PVC 之后，工作可以得到进一步的细分：</p><ul><li>存储：存储工程师维护</li><li>PV： kubernetes 管理员维护</li><li>PVC：kubernetes 用户维护</li></ul><h3 id="pv"><a class="anchor" href="#pv">#</a> PV</h3><p>PV 是存储资源的抽象，下面是资源清单文件:</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv2</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span> <span class="token comment"># 存储类型，与底层真正存储对应</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>  <span class="token comment"># 存储能力，目前只支持存储空间的设置</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 2Gi</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>  <span class="token comment"># 访问模式</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token comment"># 存储类别</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> <span class="token comment"># 回收策略</span></pre></td></tr></table></figure><p>PV 的关键配置参数说明：</p><ul><li><p><strong>存储类型</strong></p><p>底层实际存储的类型，kubernetes 支持多种存储类型，每种存储类型的配置都有所差异</p></li><li><p><strong>存储能力（capacity）</strong></p></li></ul><p>​ 目前只支持存储空间的设置 (storage=1Gi)，不过未来可能会加入 IOPS、吞吐量等指标的配置</p><ul><li><p><strong>访问模式（accessModes）</strong></p><p>用于描述用户应用对存储资源的访问权限，访问权限包括下面几种方式：</p><ul><li>ReadWriteOnce（RWO）：读写权限，但是只能被单个节点挂载</li><li>ReadOnlyMany（ROX）： 只读权限，可以被多个节点挂载</li><li>ReadWriteMany（RWX）：读写权限，可以被多个节点挂载</li></ul><p><code>需要注意的是，底层不同的存储类型可能支持的访问模式不同</code></p></li><li><p><strong>回收策略（persistentVolumeReclaimPolicy）</strong></p><p>当 PV 不再被使用了之后，对其的处理方式。目前支持三种策略：</p><ul><li>Retain （保留） 保留数据，需要管理员手工清理数据</li><li>Recycle（回收） 清除 PV 中的数据，效果相当于执行 rm -rf /thevolume/*</li><li>Delete （删除） 与 PV 相连的后端存储完成 volume 的删除操作，当然这常见于云服务商的存储服务</li></ul><p><code>需要注意的是，底层不同的存储类型可能支持的回收策略不同</code></p></li><li><p><strong>存储类别</strong></p><p>PV 可以通过 storageClassName 参数指定一个存储类别</p><ul><li><p>具有特定类别的 PV 只能与请求了该类别的 PVC 进行绑定</p></li><li><p>未设定类别的 PV 则只能与不请求任何类别的 PVC 进行绑定</p></li></ul></li><li><p><strong>状态（status）</strong></p><p>一个 PV 的生命周期中，可能会处于 4 中不同的阶段：</p><ul><li>Available（可用）： 表示可用状态，还未被任何 PVC 绑定</li><li>Bound（已绑定）： 表示 PV 已经被 PVC 绑定</li><li>Released（已释放）： 表示 PVC 被删除，但是资源还未被集群重新声明</li><li>Failed（失败）： 表示该 PV 的自动回收失败</li></ul></li></ul><p><strong>实验</strong></p><p>使用 NFS 作为存储，来演示 PV 的使用，创建 3 个 PV，对应 NFS 中的 3 个暴露的路径。</p><ol><li>准备 NFS 环境</li></ol><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建目录</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># mkdir /root/data/&#123;pv1,pv2,pv3&#125; -pv</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 暴露服务</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># more /etc/exports</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">/</span>root/<span class="token keyword">data</span><span class="token operator">/</span>pv1     192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>109<span class="token punctuation">.</span>0/24<span class="token punctuation">(</span>rw<span class="token punctuation">,</span>no_root_squash<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">/</span>root/<span class="token keyword">data</span><span class="token operator">/</span>pv2     192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>109<span class="token punctuation">.</span>0/24<span class="token punctuation">(</span>rw<span class="token punctuation">,</span>no_root_squash<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token operator">/</span>root/<span class="token keyword">data</span><span class="token operator">/</span>pv3     192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>109<span class="token punctuation">.</span>0/24<span class="token punctuation">(</span>rw<span class="token punctuation">,</span>no_root_squash<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 重启服务</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment">#  systemctl restart nfs</span></pre></td></tr></table></figure><ol start="2"><li>创建 pv.yaml</li></ol><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span>  pv1</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi</pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">-</span> ReadWriteMany</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain</pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/pv1</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.109.100</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume</pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span>  pv2</pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 2Gi</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">-</span> ReadWriteMany</pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain</pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/pv2</pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.109.100</pre></td></tr><tr><td data-num="30"></td><td><pre>    </pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume</pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span>  pv3</pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 3Gi</pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token punctuation">-</span> ReadWriteMany</pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain</pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/pv3</pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.109.100</pre></td></tr></table></figure><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 pv</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl create -f pv.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>persistentvolume/pv1 created</pre></td></tr><tr><td data-num="4"></td><td><pre>persistentvolume/pv2 created</pre></td></tr><tr><td data-num="5"></td><td><pre>persistentvolume/pv3 created</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 查看 pv</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl get pv -o wide</span></pre></td></tr><tr><td data-num="9"></td><td><pre>NAME   CAPACITY   ACCESS MODES  RECLAIM POLICY  STATUS      AGE   VOLUMEMODE</pre></td></tr><tr><td data-num="10"></td><td><pre>pv1    1Gi        RWX            Retain        Available    10s   Filesystem</pre></td></tr><tr><td data-num="11"></td><td><pre>pv2    2Gi        RWX            Retain        Available    10s   Filesystem</pre></td></tr><tr><td data-num="12"></td><td><pre>pv3    3Gi        RWX            Retain        Available    9s    Filesystem</pre></td></tr></table></figure><h3 id="pvc"><a class="anchor" href="#pvc">#</a> PVC</h3><p>PVC 是资源的申请，用来声明对存储空间、访问模式、存储类别需求信息。下面是资源清单文件:</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token comment"># 访问模式</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 采用标签对 PV 选择</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token comment"># 存储类别</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment"># 请求空间</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">requests</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi</pre></td></tr></table></figure><p>PVC 的关键配置参数说明：</p><ul><li><strong>访问模式（accessModes）</strong></li></ul><p>​ 用于描述用户应用对存储资源的访问权限</p><ul><li><p><strong>选择条件（selector）</strong></p><p>通过 Label Selector 的设置，可使 PVC 对于系统中己存在的 PV 进行筛选</p></li><li><p><strong>存储类别（storageClassName）</strong></p><p>PVC 在定义时可以设定需要的后端存储的类别，只有设置了该 class 的 pv 才能被系统选出</p></li><li><p><strong>资源请求（Resources ）</strong></p><p>描述对存储资源的请求</p></li></ul><p><strong>实验</strong></p><ol><li>创建 pvc.yaml，申请 pv</li></ol><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc1</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> ReadWriteMany</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">requests</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi</pre></td></tr><tr><td data-num="12"></td><td><pre>      </pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc2</pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">-</span> ReadWriteMany</pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token key atrule">requests</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi</pre></td></tr><tr><td data-num="26"></td><td><pre>     </pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim</pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc3</pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token punctuation">-</span> ReadWriteMany</pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token key atrule">requests</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi</pre></td></tr></table></figure><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 pvc</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl create -f pvc.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>persistentvolumeclaim/pvc1 created</pre></td></tr><tr><td data-num="4"></td><td><pre>persistentvolumeclaim/pvc2 created</pre></td></tr><tr><td data-num="5"></td><td><pre>persistentvolumeclaim/pvc3 created</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 查看 pvc</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl get pvc  -n dev -o wide</span></pre></td></tr><tr><td data-num="9"></td><td><pre>NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE   VOLUMEMODE</pre></td></tr><tr><td data-num="10"></td><td><pre>pvc1   Bound    pv1      1Gi        RWX                           15s   Filesystem</pre></td></tr><tr><td data-num="11"></td><td><pre>pvc2   Bound    pv2      2Gi        RWX                           15s   Filesystem</pre></td></tr><tr><td data-num="12"></td><td><pre>pvc3   Bound    pv3      3Gi        RWX                           15s   Filesystem</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># 查看 pv</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl get pv -o wide</span></pre></td></tr><tr><td data-num="16"></td><td><pre>NAME  CAPACITY ACCESS MODES  RECLAIM POLICY  STATUS    CLAIM       AGE     VOLUMEMODE</pre></td></tr><tr><td data-num="17"></td><td><pre>pv1    1Gi        RWx        Retain          Bound    dev/pvc1    3h37m    Filesystem</pre></td></tr><tr><td data-num="18"></td><td><pre>pv2    2Gi        RWX        Retain          Bound    dev/pvc2    3h37m    Filesystem</pre></td></tr><tr><td data-num="19"></td><td><pre>pv3    3Gi        RWX        Retain          Bound    dev/pvc3    3h37m    Filesystem</pre></td></tr></table></figure><ol start="2"><li>创建 pods.yaml, 使用 pv</li></ol><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod1</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"while true;do echo pod1 >> /root/out.txt; sleep 10; done;"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume</pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /root/</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume</pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> pvc1</pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod2</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox</pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"while true;do echo pod2 >> /root/out.txt; sleep 10; done;"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume</pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /root/</pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume</pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> pvc2</pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr></table></figure><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl create -f pods.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod1 created</pre></td></tr><tr><td data-num="4"></td><td><pre>pod/pod2 created</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 查看 pod</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl get pods -n dev -o wide</span></pre></td></tr><tr><td data-num="8"></td><td><pre>NAME   READY   STATUS    RESTARTS   AGE   IP            NODE   </pre></td></tr><tr><td data-num="9"></td><td><pre>pod1   1/1     Running   0          14s   10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>1<span class="token punctuation">.</span>69   node1   </pre></td></tr><tr><td data-num="10"></td><td><pre>pod2   1/1     Running   0          14s   10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>1<span class="token punctuation">.</span>70   node1  </pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 查看 pvc</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl get pvc -n dev -o wide</span></pre></td></tr><tr><td data-num="14"></td><td><pre>NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES      AGE   VOLUMEMODE</pre></td></tr><tr><td data-num="15"></td><td><pre>pvc1   Bound    pv1      1Gi        RWX               94m   Filesystem</pre></td></tr><tr><td data-num="16"></td><td><pre>pvc2   Bound    pv2      2Gi        RWX               94m   Filesystem</pre></td></tr><tr><td data-num="17"></td><td><pre>pvc3   Bound    pv3      3Gi        RWX               94m   Filesystem</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># 查看 pv</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl get pv -n dev -o wide</span></pre></td></tr><tr><td data-num="21"></td><td><pre>NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM       AGE     VOLUMEMODE</pre></td></tr><tr><td data-num="22"></td><td><pre>pv1    1Gi        RWX            Retain           Bound    dev/pvc1    5h11m   Filesystem</pre></td></tr><tr><td data-num="23"></td><td><pre>pv2    2Gi        RWX            Retain           Bound    dev/pvc2    5h11m   Filesystem</pre></td></tr><tr><td data-num="24"></td><td><pre>pv3    3Gi        RWX            Retain           Bound    dev/pvc3    5h11m   Filesystem</pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># 查看 nfs 中的文件存储</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># more /root/data/pv1/out.txt</span></pre></td></tr><tr><td data-num="28"></td><td><pre>node1</pre></td></tr><tr><td data-num="29"></td><td><pre>node1</pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># more /root/data/pv2/out.txt</span></pre></td></tr><tr><td data-num="31"></td><td><pre>node2</pre></td></tr><tr><td data-num="32"></td><td><pre>node2</pre></td></tr></table></figure><h3 id="生命周期"><a class="anchor" href="#生命周期">#</a> 生命周期</h3><p>PVC 和 PV 是一一对应的，PV 和 PVC 之间的相互作用遵循以下生命周期：</p><ul><li><p><strong>资源供应</strong>：管理员手动创建底层存储和 PV</p></li><li><p><strong>资源绑定</strong>：用户创建 PVC，kubernetes 负责根据 PVC 的声明去寻找 PV，并绑定</p><p>在用户定义好 PVC 之后，系统将根据 PVC 对存储资源的请求在已存在的 PV 中选择一个满足条件的</p><ul><li><p>一旦找到，就将该 PV 与用户定义的 PVC 进行绑定，用户的应用就可以使用这个 PVC 了</p></li><li><p>如果找不到，PVC 则会无限期处于 Pending 状态，直到等到系统管理员创建了一个符合其要求的 PV</p></li></ul><p>PV 一旦绑定到某个 PVC 上，就会被这个 PVC 独占，不能再与其他 PVC 进行绑定了</p></li><li><p><strong>资源使用</strong>：用户可在 pod 中像 volume 一样使用 pvc</p><p>Pod 使用 Volume 的定义，将 PVC 挂载到容器内的某个路径进行使用。</p></li><li><p><strong>资源释放</strong>：用户删除 pvc 来释放 pv</p><p>当存储资源使用完毕后，用户可以删除 PVC，与该 PVC 绑定的 PV 将会被标记为 “已释放”，但还不能立刻与其他 PVC 进行绑定。通过之前 PVC 写入的数据可能还被留在存储设备上，只有在清除之后该 PV 才能再次使用。</p></li><li><p><strong>资源回收</strong>：kubernetes 根据 pv 设置的回收策略进行资源的回收</p><p>对于 PV，管理员可以设定回收策略，用于设置与之绑定的 PVC 释放资源之后如何处理遗留数据的问题。只有 PV 的存储空间完成回收，才能供新的 PVC 绑定和使用</p></li></ul><p><img data-src="http://qiniu.baim0.cn/img/image-20200515002806726-20221022211835548.png" alt=""></p><h2 id="配置存储"><a class="anchor" href="#配置存储">#</a> 配置存储</h2><h3 id="configmap"><a class="anchor" href="#configmap">#</a> ConfigMap</h3><p>ConfigMap 是一种比较特殊的存储卷，它的主要作用是用来存储配置信息的。</p><p>创建 configmap.yaml，内容如下：</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> configmap</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">data</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">info</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span></pre></td></tr><tr><td data-num="8"></td><td><pre>    username:admin</pre></td></tr><tr><td data-num="9"></td><td><pre>    password:123456</pre></td></tr></table></figure><p>接下来，使用此配置文件创建 configmap</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 configmap</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl create -f configmap.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>configmap/configmap created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 configmap 详情</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl describe cm configmap -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>Name:         configmap</pre></td></tr><tr><td data-num="8"></td><td><pre>Namespace:    dev</pre></td></tr><tr><td data-num="9"></td><td><pre>Labels:       &lt;none></pre></td></tr><tr><td data-num="10"></td><td><pre>Annotations:  &lt;none></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">Data</span></pre></td></tr><tr><td data-num="13"></td><td><pre>====</pre></td></tr><tr><td data-num="14"></td><td><pre>info:</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span></pre></td></tr><tr><td data-num="16"></td><td><pre>username:admin</pre></td></tr><tr><td data-num="17"></td><td><pre>password:123456</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>Events:  &lt;none></pre></td></tr></table></figure><p>接下来创建一个 pod-configmap.yaml，将上面创建的 configmap 挂载进去</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>configmap</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span> <span class="token comment"># 将 configmap 挂载到目录</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /configmap/config</pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span> <span class="token comment"># 引用 configmap</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">configMap</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">name</span><span class="token punctuation">:</span> configmap</pre></td></tr></table></figure><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl create -f pod-configmap.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod-configmap created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 pod</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl get pod pod-configmap -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME            READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>pod-configmap   1/1     Running   0          6s</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#进入容器</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl exec -it pod-configmap -n dev /bin/sh</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># cd /configmap/config/</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># ls</span></pre></td></tr><tr><td data-num="14"></td><td><pre>info</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># more info</span></pre></td></tr><tr><td data-num="16"></td><td><pre>username:admin</pre></td></tr><tr><td data-num="17"></td><td><pre>password:123456</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment"># 可以看到映射已经成功，每个 configmap 都映射成了一个目录</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># key---> 文件     value----> 文件中的内容</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># 此时如果更新 configmap 的内容，容器中的值也会动态更新</span></pre></td></tr></table></figure><h3 id="secret"><a class="anchor" href="#secret">#</a> Secret</h3><p>​ 在 kubernetes 中，还存在一种和 ConfigMap 非常类似的对象，称为 Secret 对象。它主要用于存储敏感信息，例如密码、秘钥、证书等等。</p><ol><li>首先使用 base64 对数据进行编码</li></ol><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># echo -n 'admin' | base64 #准备 username</span></pre></td></tr><tr><td data-num="2"></td><td><pre>YWRtaW4=</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># echo -n '123456' | base64 #准备 password</span></pre></td></tr><tr><td data-num="4"></td><td><pre>MTIzNDU2</pre></td></tr></table></figure><ol start="2"><li>接下来编写 secret.yaml，并创建 Secret</li></ol><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> secret</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">data</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">username</span><span class="token punctuation">:</span> YWRtaW4=</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">password</span><span class="token punctuation">:</span> MTIzNDU2</pre></td></tr></table></figure><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 secret</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl create -f secret.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>secret/secret created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 secret 详情</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl describe secret secret -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>Name:         secret</pre></td></tr><tr><td data-num="8"></td><td><pre>Namespace:    dev</pre></td></tr><tr><td data-num="9"></td><td><pre>Labels:       &lt;none></pre></td></tr><tr><td data-num="10"></td><td><pre>Annotations:  &lt;none></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token function">Type</span>:  Opaque</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">Data</span></pre></td></tr><tr><td data-num="13"></td><td><pre>====</pre></td></tr><tr><td data-num="14"></td><td><pre>password:  6 bytes</pre></td></tr><tr><td data-num="15"></td><td><pre>username:  5 bytes</pre></td></tr></table></figure><ol start="3"><li>创建 pod-secret.yaml，将上面创建的 secret 挂载进去：</li></ol><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>secret</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">containers</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span> <span class="token comment"># 将 secret 挂载到目录</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /secret/config</pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">secret</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> secret</pre></td></tr></table></figure><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 pod</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl create -f pod-secret.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre>pod/pod-secret created</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 查看 pod</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl get pod pod-secret -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME            READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>pod-secret      1/1     Running   0          2m28s</pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 进入容器，查看 secret 信息，发现已经自动解码了</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl exec -it pod-secret /bin/sh -n dev</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token operator">/</span> <span class="token comment"># ls /secret/config/</span></pre></td></tr><tr><td data-num="13"></td><td><pre>password  username</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token operator">/</span> <span class="token comment"># more /secret/config/username</span></pre></td></tr><tr><td data-num="15"></td><td><pre>admin</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token operator">/</span> <span class="token comment"># more /secret/config/password</span></pre></td></tr><tr><td data-num="17"></td><td><pre>123456</pre></td></tr></table></figure><p>至此，已经实现了利用 secret 实现了信息的编码。</p><h1 id="第九章-安全认证"><a class="anchor" href="#第九章-安全认证">#</a> 第九章 安全认证</h1><p>本章节主要介绍 Kubernetes 的安全认证机制。</p><h2 id="访问控制概述"><a class="anchor" href="#访问控制概述">#</a> 访问控制概述</h2><p>​ Kubernetes 作为一个分布式集群的管理工具，保证集群的安全性是其一个重要的任务。所谓的安全性其实就是保证对 Kubernetes 的各种<strong>客户端</strong>进行<strong>认证和鉴权</strong>操作。</p><p><strong>客户端</strong></p><p>在 Kubernetes 集群中，客户端通常有两类：</p><ul><li><p><strong>User Account</strong>：一般是独立于 kubernetes 之外的其他服务管理的用户账号。</p></li><li><p><strong>Service Account</strong>：kubernetes 管理的账号，用于为 Pod 中的服务进程在访问 Kubernetes 时提供身份标识。</p></li></ul><p><img data-src="http://qiniu.baim0.cn/img/image-20200520102949189-20221022211852205.png" alt=""></p><p><strong>认证、授权与准入控制</strong></p><p>ApiServer 是访问及管理资源对象的唯一入口。任何一个请求访问 ApiServer，都要经过下面三个流程：</p><ul><li>Authentication（认证）：身份鉴别，只有正确的账号才能够通过认证</li><li>Authorization（授权）： 判断用户是否有权限对访问的资源执行特定的动作</li><li>Admission Control（准入控制）：用于补充授权机制以实现更加精细的访问控制功能。</li></ul><p><img data-src="http://qiniu.baim0.cn/img/image-20200520103942580-20221022211906143.png" alt=""></p><h2 id="认证管理"><a class="anchor" href="#认证管理">#</a> 认证管理</h2><p>Kubernetes 集群安全的最关键点在于如何识别并认证客户端身份，它提供了 3 种客户端身份认证方式：</p><ul><li><p>HTTP Base 认证：通过用户名 + 密码的方式认证</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre>这种认证方式是把“用户名:密码”用BASE64算法进行编码后的字符串放在HTTP请求中的Header Authorization域里发送给服务端。服务端收到后进行解码，获取用户名及密码，然后进行用户身份认证的过程。</pre></td></tr></table></figure></li><li><p>HTTP Token 认证：通过一个 Token 来识别合法用户</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre>这种认证方式是用一个很长的难以被模仿的字符串--Token来表明客户身份的一种方式。每个Token对应一个用户名，当客户端发起API调用请求时，需要在HTTP Header里放入Token，API Server接到Token后会跟服务器中保存的token进行比对，然后进行用户身份认证的过程。</pre></td></tr></table></figure></li><li><p>HTTPS 证书认证：基于 CA 根证书签名的双向数字证书认证方式</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre>这种认证方式是安全性最高的一种方式，但是同时也是操作起来最麻烦的一种方式。</pre></td></tr></table></figure></li></ul><p><img data-src="http://qiniu.baim0.cn/img/image-20200518211037434-20221022211919854.png" alt=""></p><p><strong>HTTPS 认证大体分为 3 个过程：</strong></p><ol><li><p>证书申请和下发</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre>HTTPS通信双方的服务器向CA机构申请证书，CA机构下发根证书、服务端证书及私钥给申请者</pre></td></tr></table></figure></li><li><p>客户端和服务端的双向认证</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre>1> 客户端向服务器端发起请求，服务端下发自己的证书给客户端，</pre></td></tr><tr><td data-num="2"></td><td><pre>     客户端接收到证书后，通过私钥解密证书，在证书中获得服务端的公钥，</pre></td></tr><tr><td data-num="3"></td><td><pre>     客户端利用服务器端的公钥认证证书中的信息，如果一致，则认可这个服务器</pre></td></tr><tr><td data-num="4"></td><td><pre>  2> 客户端发送自己的证书给服务器端，服务端接收到证书后，通过私钥解密证书，</pre></td></tr><tr><td data-num="5"></td><td><pre>     在证书中获得客户端的公钥，并用该公钥认证证书信息，确认客户端是否合法</pre></td></tr></table></figure></li><li><p>服务器端和客户端进行通信</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre>服务器端和客户端协商好加密方案后，客户端会产生一个随机的秘钥并加密，然后发送到服务器端。</pre></td></tr><tr><td data-num="2"></td><td><pre>  服务器端接收这个秘钥后，双方接下来通信的所有内容都通过该随机秘钥加密</pre></td></tr></table></figure></li></ol><blockquote><p>注意: Kubernetes 允许同时配置多种认证方式，只要其中任意一个方式认证通过即可</p></blockquote><h2 id="授权管理"><a class="anchor" href="#授权管理">#</a> 授权管理</h2><p>​ 授权发生在认证成功之后，通过认证就可以知道请求用户是谁， 然后 Kubernetes 会根据事先定义的授权策略来决定用户是否有权限访问，这个过程就称为授权。</p><p>​ 每个发送到 ApiServer 的请求都带上了用户和资源的信息：比如发送请求的用户、请求的路径、请求的动作等，授权就是根据这些信息和授权策略进行比较，如果符合策略，则认为授权通过，否则会返回错误。</p><p>API Server 目前支持以下几种授权策略：</p><ul><li><p>AlwaysDeny：表示拒绝所有请求，一般用于测试</p></li><li><p>AlwaysAllow：允许接收所有请求，相当于集群不需要授权流程（Kubernetes 默认的策略）</p></li><li><p>ABAC：基于属性的访问控制，表示使用用户配置的授权规则对用户请求进行匹配和控制</p></li><li><p>Webhook：通过调用外部 REST 服务对用户进行授权</p></li><li><p>Node：是一种专用模式，用于对 kubelet 发出的请求进行访问控制</p></li><li><p>RBAC：基于角色的访问控制（kubeadm 安装方式下的默认选项）</p></li></ul><p>RBAC (Role-Based Access Control) 基于角色的访问控制，主要是在描述一件事情：<strong>给哪些对象授予了哪些权限</strong></p><p>其中涉及到了下面几个概念：</p><ul><li>对象：User、Groups、ServiceAccount</li><li>角色：代表着一组定义在资源上的可操作动作 (权限) 的集合</li><li>绑定：将定义好的角色跟用户绑定在一起</li></ul><p><img data-src="http://qiniu.baim0.cn/img/image-20200519181209566-20221022211932915.png" alt=""></p><p>RBAC 引入了 4 个顶级资源对象：</p><ul><li>Role、ClusterRole：角色，用于指定一组权限</li><li>RoleBinding、ClusterRoleBinding：角色绑定，用于将角色（权限）赋予给对象</li></ul><p><strong>Role、ClusterRole</strong></p><p>一个角色就是一组权限的集合，这里的权限都是许可形式的（白名单）。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Role 只能对命名空间内的资源进行授权，需要指定 nameapce</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Role</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  namespace<span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="6"></td><td><pre>  name<span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">rules</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>  <span class="token comment"># 支持的 API 组列表，"" 空字符串，表示核心 API 群</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  resources<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">]</span> <span class="token comment"># 支持的资源对象列表</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  verbs<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span> <span class="token comment"># 允许的对资源对象的操作方法列表</span></pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ClusterRole 可以对集群范围内资源、跨 namespaces 的范围资源、非资源类型进行授权</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>clusterrole</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">rules</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span></pre></td></tr></table></figure><p>需要详细说明的是，rules 中的参数：</p><ul><li><p>apiGroups: 支持的 API 组列表</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token string">""</span>,<span class="token string">"apps"</span>, <span class="token string">"autoscaling"</span>, <span class="token string">"batch"</span></pre></td></tr></table></figure></li><li><p>resources：支持的资源对象列表</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token string">"services"</span>, <span class="token string">"endpoints"</span>, <span class="token string">"pods"</span>,<span class="token string">"secrets"</span>,<span class="token string">"configmaps"</span>,<span class="token string">"crontabs"</span>,<span class="token string">"deployments"</span>,<span class="token string">"jobs"</span>,</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token string">"nodes"</span>,<span class="token string">"rolebindings"</span>,<span class="token string">"clusterroles"</span>,<span class="token string">"daemonsets"</span>,<span class="token string">"replicasets"</span>,<span class="token string">"statefulsets"</span>,</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token string">"horizontalpodautoscalers"</span>,<span class="token string">"replicationcontrollers"</span>,<span class="token string">"cronjobs"</span></pre></td></tr></table></figure></li><li><p>verbs：对资源对象的操作方法列表</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token string">"get"</span>, <span class="token string">"list"</span>, <span class="token string">"watch"</span>, <span class="token string">"create"</span>, <span class="token string">"update"</span>, <span class="token string">"patch"</span>, <span class="token string">"delete"</span>, <span class="token string">"exec"</span></pre></td></tr></table></figure></li></ul><p><strong>RoleBinding、ClusterRoleBinding</strong></p><p>角色绑定用来把一个角色绑定到一个目标对象上，绑定目标可以是 User、Group 或者 ServiceAccount。</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># RoleBinding 可以将同一 namespace 中的 subject 绑定到某个 Role 下，则此 subject 即具有该 Role 定义的权限</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role<span class="token punctuation">-</span>binding</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">subjects</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> heima</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token key atrule">roleRef</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role</pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ClusterRoleBinding 在整个集群级别和所有 namespaces 将特定的 subject 与 ClusterRole 绑定，授予权限</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>clusterrole<span class="token punctuation">-</span>binding</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">subjects</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User</pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> heima</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token key atrule">roleRef</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole</pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>clusterrole</pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr></table></figure><p><strong>RoleBinding 引用 ClusterRole 进行授权</strong></p><p>RoleBinding 可以引用 ClusterRole，对属于同一命名空间内 ClusterRole 定义的资源主体进行授权。</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre>一种很常用的做法就是，集群管理员为集群范围预定义好一组角色（ClusterRole），然后在多个命名空间中重复使用这些ClusterRole。这样可以大幅提高授权管理工作效率，也使得各个命名空间下的基础性授权规则与使用体验保持一致。</pre></td></tr></table></figure><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 虽然 authorization-clusterrole 是一个集群角色，但是因为使用了 RoleBinding</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 所以 heima 只能读取 dev 命名空间中的资源</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  name<span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role<span class="token punctuation">-</span>binding<span class="token punctuation">-</span>ns</pre></td></tr><tr><td data-num="7"></td><td><pre>  namespace<span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">subjects</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User</pre></td></tr><tr><td data-num="10"></td><td><pre>  name<span class="token punctuation">:</span> heima</pre></td></tr><tr><td data-num="11"></td><td><pre>  apiGroup<span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token key atrule">roleRef</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  kind<span class="token punctuation">:</span> ClusterRole</pre></td></tr><tr><td data-num="14"></td><td><pre>  name<span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>clusterrole</pre></td></tr><tr><td data-num="15"></td><td><pre>  apiGroup<span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr></table></figure><p><strong>实战：创建一个只能管理 dev 空间下 Pods 资源的账号</strong></p><ol><li>创建账号</li></ol><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 1) 创建证书</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master pki]</span><span class="token comment"># cd /etc/kubernetes/pki/</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token namespace">[root@master pki]</span><span class="token comment"># (umask 077;openssl genrsa -out devman.key 2048)</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 2) 用 apiserver 的证书去签署</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 2-1) 签名申请，申请的用户是 devman, 组是 devgroup</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token namespace">[root@master pki]</span><span class="token comment"># openssl req -new -key devman.key -out devman.csr -subj "/CN=devman/O=devgroup"     </span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 2-2) 签署证书</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token namespace">[root@master pki]</span><span class="token comment"># openssl x509 -req -in devman.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out devman.crt -days 3650</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 3) 设置集群、用户、上下文信息</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token namespace">[root@master pki]</span><span class="token comment"># kubectl config set-cluster kubernetes --embed-certs=true --certificate-authority=/etc/kubernetes/pki/ca.crt --server=https://192.168.109.100:6443</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token namespace">[root@master pki]</span><span class="token comment"># kubectl config set-credentials devman --embed-certs=true --client-certificate=/etc/kubernetes/pki/devman.crt --client-key=/etc/kubernetes/pki/devman.key</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token namespace">[root@master pki]</span><span class="token comment"># kubectl config set-context devman@kubernetes --cluster=kubernetes --user=devman</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment"># 切换账户到 devman</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token namespace">[root@master pki]</span><span class="token comment"># kubectl config use-context devman@kubernetes</span></pre></td></tr><tr><td data-num="20"></td><td><pre>Switched to context <span class="token string">"devman@kubernetes"</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># 查看 dev 下 pod，发现没有权限</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token namespace">[root@master pki]</span><span class="token comment"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num="24"></td><td><pre>Error <span class="token keyword">from</span> server <span class="token punctuation">(</span>Forbidden<span class="token punctuation">)</span>: pods is forbidden: User <span class="token string">"devman"</span> cannot list resource <span class="token string">"pods"</span> in API <span class="token function">group</span> <span class="token string">""</span> in the namespace <span class="token string">"dev"</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># 切换到 admin 账户</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token namespace">[root@master pki]</span><span class="token comment"># kubectl config use-context kubernetes-admin@kubernetes</span></pre></td></tr><tr><td data-num="28"></td><td><pre>Switched to context <span class="token string">"kubernetes-admin@kubernetes"</span><span class="token punctuation">.</span></pre></td></tr></table></figure><p>2） 创建 Role 和 RoleBinding，为 devman 用户授权</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Role</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> dev<span class="token punctuation">-</span>role</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">rules</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token key atrule">metadata</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role<span class="token punctuation">-</span>binding</pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token key atrule">subjects</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User</pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> devman</pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token key atrule">roleRef</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> dev<span class="token punctuation">-</span>role</pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></td></tr></table></figure><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token namespace">[root@master pki]</span><span class="token comment"># kubectl create -f dev-role.yaml</span></pre></td></tr><tr><td data-num="2"></td><td><pre>role<span class="token punctuation">.</span>rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/dev-role created</pre></td></tr><tr><td data-num="3"></td><td><pre>rolebinding<span class="token punctuation">.</span>rbac<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/authorization-role-binding created</pre></td></tr></table></figure><ol start="3"><li>切换账户，再次验证</li></ol><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 切换账户到 devman</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master pki]</span><span class="token comment"># kubectl config use-context devman@kubernetes</span></pre></td></tr><tr><td data-num="3"></td><td><pre>Switched to context <span class="token string">"devman@kubernetes"</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 再次查看</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token namespace">[root@master pki]</span><span class="token comment"># kubectl get pods -n dev</span></pre></td></tr><tr><td data-num="7"></td><td><pre>NAME                                 READY   STATUS             RESTARTS   AGE</pre></td></tr><tr><td data-num="8"></td><td><pre>nginx-deployment-66cb59b984-8wp2k    1/1     Running            0          4d1h</pre></td></tr><tr><td data-num="9"></td><td><pre>nginx-deployment-66cb59b984-dc46j    1/1     Running            0          4d1h</pre></td></tr><tr><td data-num="10"></td><td><pre>nginx-deployment-66cb59b984-thfck    1/1     Running            0          4d1h</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># 为了不影响后面的学习，切回 admin 账户</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token namespace">[root@master pki]</span><span class="token comment"># kubectl config use-context kubernetes-admin@kubernetes</span></pre></td></tr><tr><td data-num="14"></td><td><pre>Switched to context <span class="token string">"kubernetes-admin@kubernetes"</span><span class="token punctuation">.</span></pre></td></tr></table></figure><h2 id="准入控制"><a class="anchor" href="#准入控制">#</a> 准入控制</h2><p>通过了前面的认证和授权之后，还需要经过准入控制处理通过之后，apiserver 才会处理这个请求。</p><p>准入控制是一个可配置的控制器列表，可以通过在 Api-Server 上通过命令行设置选择执行哪些准入控制器：</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">--</span>admission-control=NamespaceLifecycle<span class="token punctuation">,</span>LimitRanger<span class="token punctuation">,</span>ServiceAccount<span class="token punctuation">,</span>PersistentVolumeLabel<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                      DefaultStorageClass<span class="token punctuation">,</span>ResourceQuota<span class="token punctuation">,</span>DefaultTolerationSeconds</pre></td></tr></table></figure><p>只有当所有的准入控制器都检查通过之后，apiserver 才执行该请求，否则返回拒绝。</p><p>当前可配置的 Admission Control 准入控制如下：</p><ul><li>AlwaysAdmit：允许所有请求</li><li>AlwaysDeny：禁止所有请求，一般用于测试</li><li>AlwaysPullImages：在启动容器之前总去下载镜像</li><li>DenyExecOnPrivileged：它会拦截所有想在 Privileged Container 上执行命令的请求</li><li>ImagePolicyWebhook：这个插件将允许后端的一个 Webhook 程序来完成 admission controller 的功能。</li><li>Service Account：实现 ServiceAccount 实现了自动化</li><li>SecurityContextDeny：这个插件将使用 SecurityContext 的 Pod 中的定义全部失效</li><li>ResourceQuota：用于资源配额管理目的，观察所有请求，确保在 namespace 上的配额不会超标</li><li>LimitRanger：用于资源限制管理，作用于 namespace 上，确保对 Pod 进行资源限制</li><li>InitialResources：为未设置资源请求与限制的 Pod，根据其镜像的历史资源的使用情况进行设置</li><li>NamespaceLifecycle：如果尝试在一个不存在的 namespace 中创建资源对象，则该创建请求将被拒绝。当删除一个 namespace 时，系统将会删除该 namespace 中所有对象。</li><li>DefaultStorageClass：为了实现共享存储的动态供应，为未指定 StorageClass 或 PV 的 PVC 尝试匹配默认的 StorageClass，尽可能减少用户在申请 PVC 时所需了解的后端存储细节</li><li>DefaultTolerationSeconds：这个插件为那些没有设置 forgiveness tolerations 并具有 notready:NoExecute 和 unreachable:NoExecute 两种 taints 的 Pod 设置默认的 “容忍” 时间，为 5min</li><li>PodSecurityPolicy：这个插件用于在创建或修改 Pod 时决定是否根据 Pod 的 security context 和可用的 PodSecurityPolicy 对 Pod 的安全策略进行控制</li></ul><h1 id="第十章-dashboard"><a class="anchor" href="#第十章-dashboard">#</a> 第十章 DashBoard</h1><p>​ 之前在 kubernetes 中完成的所有操作都是通过命令行工具 kubectl 完成的。其实，为了提供更丰富的用户体验，kubernetes 还开发了一个基于 web 的用户界面（Dashboard）。用户可以使用 Dashboard 部署容器化的应用，还可以监控应用的状态，执行故障排查以及管理 kubernetes 中各种资源。</p><h2 id="部署dashboard"><a class="anchor" href="#部署dashboard">#</a> 部署 Dashboard</h2><ol><li>下载 yaml，并运行 Dashboard</li></ol><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 下载 yaml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># wget  https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 修改 kubernetes-dashboard 的 Service 类型</span></pre></td></tr><tr><td data-num="5"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num="6"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num="7"></td><td><pre>metadata:</pre></td></tr><tr><td data-num="8"></td><td><pre>  labels:</pre></td></tr><tr><td data-num="9"></td><td><pre>    k8s-app: kubernetes-dashboard</pre></td></tr><tr><td data-num="10"></td><td><pre>  name: kubernetes-dashboard</pre></td></tr><tr><td data-num="11"></td><td><pre>  namespace: kubernetes-dashboard</pre></td></tr><tr><td data-num="12"></td><td><pre>spec:</pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token function">type</span>: NodePort  <span class="token comment"># 新增</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  ports:</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token operator">-</span> port: 443</pre></td></tr><tr><td data-num="16"></td><td><pre>      targetPort: 8443</pre></td></tr><tr><td data-num="17"></td><td><pre>      nodePort: 30009  <span class="token comment"># 新增</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  selector:</pre></td></tr><tr><td data-num="19"></td><td><pre>    k8s-app: kubernetes-dashboard</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># 部署</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl create -f recommended.yaml</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># 查看 namespace 下的 kubernetes-dashboard 下的资源</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl get pod,svc -n kubernetes-dashboard</span></pre></td></tr><tr><td data-num="26"></td><td><pre>NAME                                            READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num="27"></td><td><pre>pod/dashboard-metrics-scraper-c79c65bb7-zwfvw   1/1     Running   0          111s</pre></td></tr><tr><td data-num="28"></td><td><pre>pod/kubernetes-dashboard-56484d4c5-z95z5        1/1     Running   0          111s</pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>NAME                               <span class="token function">TYPE</span>       CLUSTER-IP      EXTERNAL-IP  PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>         AGE</pre></td></tr><tr><td data-num="31"></td><td><pre>service/dashboard-metrics-scraper  ClusterIP  10<span class="token punctuation">.</span>96<span class="token punctuation">.</span>89<span class="token punctuation">.</span>218    &lt;none>       8000/TCP        111s</pre></td></tr><tr><td data-num="32"></td><td><pre>service/kubernetes-dashboard       NodePort   10<span class="token punctuation">.</span>104<span class="token punctuation">.</span>178<span class="token punctuation">.</span>171  &lt;none>       443:30009/TCP   111s</pre></td></tr></table></figure><p>2）创建访问账户，获取 token</p><figure class="highlight powershell"><figcaption data-lang="PowerShell"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建账号</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token namespace">[root@master-1 ~]</span><span class="token comment"># kubectl create serviceaccount dashboard-admin -n kubernetes-dashboard</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 授权</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token namespace">[root@master-1 ~]</span><span class="token comment"># kubectl create clusterrolebinding dashboard-admin-rb --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-admin</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 获取账号 token</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment">#  kubectl get secrets -n kubernetes-dashboard | grep dashboard-admin</span></pre></td></tr><tr><td data-num="9"></td><td><pre>dashboard-admin-token-xbqhh        kubernetes<span class="token punctuation">.</span>io/service-account-token   3      2m35s</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl describe secrets dashboard-admin-token-xbqhh -n kubernetes-dashboard</span></pre></td></tr><tr><td data-num="12"></td><td><pre>Name:         dashboard-admin-token-xbqhh</pre></td></tr><tr><td data-num="13"></td><td><pre>Namespace:    kubernetes-dashboard</pre></td></tr><tr><td data-num="14"></td><td><pre>Labels:       &lt;none></pre></td></tr><tr><td data-num="15"></td><td><pre>Annotations:  kubernetes<span class="token punctuation">.</span>io/service-account<span class="token punctuation">.</span>name: dashboard-admin</pre></td></tr><tr><td data-num="16"></td><td><pre>              kubernetes<span class="token punctuation">.</span>io/service-account<span class="token punctuation">.</span>uid: 95d84d80-be7a-4d10-a2e0-68f90222d039</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token function">Type</span>:  kubernetes<span class="token punctuation">.</span>io/service-account-token</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">Data</span></pre></td></tr><tr><td data-num="21"></td><td><pre>====</pre></td></tr><tr><td data-num="22"></td><td><pre>namespace:  20 bytes</pre></td></tr><tr><td data-num="23"></td><td><pre>token:      eyJhbGciOiJSUzI1NiIsImtpZCI6ImJrYkF4bW5XcDhWcmNGUGJtek5NODFuSXl1aWptMmU2M3o4LTY5a2FKS2cifQ<span class="token punctuation">.</span>eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4teGJxaGgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiOTVkODRkODAtYmU3YS00ZDEwLWEyZTAtNjhmOTAyMjJkMDM5Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9<span class="token punctuation">.</span>NAl7e8ZfWWdDoPxkqzJzTB46sK9E8iuJYnUI9vnBaY3Jts7T1g1msjsBnbxzQSYgAG-<span class="token operator">-</span>cV0WYxjndzJY_UWCwaGPrQrt_GunxmOK9AUnzURqm55GR2RXIZtjsWVP2EBatsDgHRmuUbQvTFOvdJB4x3nXcYLN2opAaMqg3rnU2rr-A8zCrIuX_eca12wIp_QiuP3SF-tzpdLpsyRfegTJZl6YnSGyaVkC9id-cxZRb307qdCfXPfCHR_2rt5FVfxARgg_C0e3eFHaaYQO7CitxsnIoIXpOFNAR8aUrmopJyODQIPqBWUehb7FhlU1DCduHnIIXVC_UICZ-MKYewBDLw</pre></td></tr><tr><td data-num="24"></td><td><pre>ca<span class="token punctuation">.</span>crt:     1025 bytes</pre></td></tr></table></figure><p>3）通过浏览器访问 Dashboard 的 UI</p><p>在登录页面上输入上面的 token</p><p><img data-src="http://qiniu.baim0.cn/img/image-20200520144548997-20221022211958596.png" alt=""></p><p>出现下面的页面代表成功</p><p><img data-src="http://qiniu.baim0.cn/img/image-20200520144959353-20221022212012528.png" alt=""></p><h2 id="使用dashboard"><a class="anchor" href="#使用dashboard">#</a> 使用 DashBoard</h2><p>本章节以 Deployment 为例演示 DashBoard 的使用</p><p><strong>查看</strong></p><p>选择指定的命名空间 <code>dev</code> ，然后点击 <code>Deployments</code> ，查看 dev 空间下的所有 deployment</p><p><img data-src="http://qiniu.baim0.cn/img/image-20200520154628679-20221022212049536.png" alt=""></p><p><strong>扩缩容</strong></p><p>在 <code>Deployment</code> 上点击 <code>规模</code> ，然后指定 <code>目标副本数量</code> ，点击确定</p><p><img data-src="http://qiniu.baim0.cn/img/image-20200520162605102-20221022212104404.png" alt=""></p><p><strong>编辑</strong></p><p>在 <code>Deployment</code> 上点击 <code>编辑</code> ，然后修改 <code>yaml文件</code> ，点击确定</p><p><img data-src="http://qiniu.baim0.cn/img/image-20200520163253644-20221022212141018.png" alt=""></p><p><strong>查看 Pod</strong></p><p>点击 <code>Pods</code> , 查看 pods 列表</p><p><img data-src="http://qiniu.baim0.cn/img/image-20200520163552110-20221022212154346.png" alt=""></p><p><strong>操作 Pod</strong></p><p>选中某个 Pod，可以对其执行日志（logs）、进入执行（exec）、编辑、删除操作</p><p><img data-src="http://qiniu.baim0.cn/img/image-20200520163832827-20221022212211975.png" alt=""></p><blockquote><p>Dashboard 提供了 kubectl 的绝大部分功能，这里不再一一演示</p></blockquote><div class="tags"><a href="/tags/kubernetes/" rel="tag"><i class="ic i-tag"></i> kubernetes</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-10-22 21:22:16" itemprop="dateModified" datetime="2022-10-22T21:22:16+08:00">2022-10-22</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="baim0 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="baim0 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="baim0 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>baim0 <i class="ic i-at"><em>@</em></i>桃花影落飞神剑,碧海潮生按玉箫</li><li class="link"><strong>本文链接：</strong> <a href="http://yoursite.com/kubernetes/Kubernetes8/" title="08 数据存储">http://yoursite.com/kubernetes/Kubernetes8/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/kubernetes/Kubernetes7/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclip4jbpj20zk0m87cv.jpg" title="07 Service详解"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> kubernetes</span><h3>07 Service详解</h3></a></div><div class="item right"></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E7%AB%A0-%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8"><span class="toc-number">1.</span> <span class="toc-text">第八章 数据存储</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%AD%98%E5%82%A8"><span class="toc-number">1.1.</span> <span class="toc-text">基本存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#emptydir"><span class="toc-number">1.1.1.</span> <span class="toc-text">EmptyDir</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hostpath"><span class="toc-number">1.1.2.</span> <span class="toc-text">HostPath</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nfs"><span class="toc-number">1.1.3.</span> <span class="toc-text">NFS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pv%E5%92%8Cpvc"><span class="toc-number">1.1.4.</span> <span class="toc-text">PV 和 PVC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pv"><span class="toc-number">1.1.5.</span> <span class="toc-text">PV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pvc"><span class="toc-number">1.1.6.</span> <span class="toc-text">PVC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.1.7.</span> <span class="toc-text">生命周期</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%AD%98%E5%82%A8"><span class="toc-number">1.2.</span> <span class="toc-text">配置存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#configmap"><span class="toc-number">1.2.1.</span> <span class="toc-text">ConfigMap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#secret"><span class="toc-number">1.2.2.</span> <span class="toc-text">Secret</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81"><span class="toc-number">2.</span> <span class="toc-text">第九章 安全认证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E6%A6%82%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text">访问控制概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E7%AE%A1%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">认证管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E7%AE%A1%E7%90%86"><span class="toc-number">2.3.</span> <span class="toc-text">授权管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6"><span class="toc-number">2.4.</span> <span class="toc-text">准入控制</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E7%AB%A0-dashboard"><span class="toc-number">3.</span> <span class="toc-text">第十章 DashBoard</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2dashboard"><span class="toc-number">3.1.</span> <span class="toc-text">部署 Dashboard</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8dashboard"><span class="toc-number">3.2.</span> <span class="toc-text">使用 DashBoard</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/kubernetes/Kubernetes1/" rel="bookmark" title="01 kubernetes介绍及安装">01 kubernetes介绍及安装</a></li><li><a href="/kubernetes/kubernetes2/" rel="bookmark" title="02 集群环境搭建">02 集群环境搭建</a></li><li><a href="/kubernetes/kubernetes3/" rel="bookmark" title="03 资源管理">03 资源管理</a></li><li><a href="/kubernetes/kubernetes4/" rel="bookmark" title="04 kubernetes实战入门">04 kubernetes实战入门</a></li><li><a href="/kubernetes/Kubernetes5/" rel="bookmark" title="05 Pod详解">05 Pod详解</a></li><li><a href="/kubernetes/kubernetes6/" rel="bookmark" title="06 Pod控制器详解">06 Pod控制器详解</a></li><li><a href="/kubernetes/Kubernetes7/" rel="bookmark" title="07 Service详解">07 Service详解</a></li><li class="active"><a href="/kubernetes/Kubernetes8/" rel="bookmark" title="08 数据存储">08 数据存储</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="baim0" data-src="/images/avatar.jpg"><p class="name" itemprop="name">baim0</p><div class="description" itemprop="description">描述123</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">9</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">2</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">2</span> <span class="name">标签</span></a></div></nav><div class="social"></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/categories/kubernetes" rel="section"><i class="ic i-kubernetes"></i>kubernetes</a></li><li class="item"><span class="exturl" data-url="aHR0cHM6Ly93d3cueXVxdWUuY29tL2JhaW0wL2dvbGFuZw=="><i class="ic i-golang"></i>golang</span></li><li class="item"><a href="/categories/vue" rel="section"><i class="ic i-vue"></i>vue</a></li><li class="item"><a href="/categories/devops" rel="section"><i class="ic i-devops"></i>devops</a></li><li class="item"><a href="/categories/prometheus" rel="section"><i class="ic i-prometheus"></i>prometheus</a></li><li class="item"><a href="/categories/mysql" rel="section"><i class="ic i-mysql"></i>mysql</a></li><li class="item"><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZ2VuZ2Zlbmdsb2cvcC8xNTQzNDY5Ni5odG1s"><i class="ic i-python"></i>python</span></li></ul></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/happy/" title="分类于 happy">happy</a></div><span><a href="/happy/happy/" title="空气炸锅美食攻略">空气炸锅美食攻略</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/kubernetes/" title="分类于 kubernetes">kubernetes</a></div><span><a href="/kubernetes/kubernetes3/" title="03 资源管理">03 资源管理</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/kubernetes/" title="分类于 kubernetes">kubernetes</a></div><span><a href="/kubernetes/kubernetes2/" title="02 集群环境搭建">02 集群环境搭建</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/kubernetes/" title="分类于 kubernetes">kubernetes</a></div><span><a href="/kubernetes/Kubernetes1/" title="01 kubernetes介绍及安装">01 kubernetes介绍及安装</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/kubernetes/" title="分类于 kubernetes">kubernetes</a></div><span><a href="/kubernetes/kubernetes6/" title="06 Pod控制器详解">06 Pod控制器详解</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/kubernetes/" title="分类于 kubernetes">kubernetes</a></div><span><a href="/kubernetes/Kubernetes7/" title="07 Service详解">07 Service详解</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/kubernetes/" title="分类于 kubernetes">kubernetes</a></div><span><a href="/kubernetes/Kubernetes5/" title="05 Pod详解">05 Pod详解</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/kubernetes/" title="分类于 kubernetes">kubernetes</a></div><span><a href="/kubernetes/kubernetes4/" title="04 kubernetes实战入门">04 kubernetes实战入门</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/kubernetes/" title="分类于 kubernetes">kubernetes</a></div><span><a href="/kubernetes/Kubernetes8/" title="08 数据存储">08 数据存储</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">baim0 @ 白墨小客栈</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"kubernetes/Kubernetes8/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>